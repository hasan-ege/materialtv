
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ExpandingSearchBar(
    isExpanded: Boolean,
    query: String,
    onQueryChange: (String) -> Unit,
    onSearch: (String) -> Unit,
    onExpandedChange: (Boolean) -> Unit,
    searchViewModel: SearchViewModel
) {
    val context = LocalContext.current
    
    // Debounced search
    LaunchedEffect(query) {
        if (query.isNotBlank()) {
            kotlinx.coroutines.delay(300)
            onSearch(query)
        }
    }
    
    AnimatedVisibility(
        visible = isExpanded,
        enter = slideInVertically(
            initialOffsetY = { -it },
            animationSpec = ExpressiveAnimations.enter()
        ) + fadeIn(animationSpec = ExpressiveAnimations.enter()),
        exit = slideOutVertically(
            targetOffsetY = { -it },
            animationSpec = ExpressiveAnimations.exit()
        ) + fadeOut(animationSpec = ExpressiveAnimations.exit())
    ) {
        Box(
            modifier = Modifier
                .fillMaxSize()
                .clickable(enabled = false) { }
        ) {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(16.dp)
            ) {
                androidx.compose.material3.SearchBar(
                    query = query,
                    onQueryChange = onQueryChange,
                    onSearch = onSearch,
                    active = true,
                    onActiveChange = { },
                    placeholder = { Text(stringResource(R.string.search_field_label)) },
                    leadingIcon = {
                        IconButton(onClick = { 
                            onQueryChange("")
                            onExpandedChange(false) 
                        }) {
                            Icon(
                                Icons.AutoMirrored.Filled.ArrowBack,
                                contentDescription = stringResource(R.string.action_back)
                            )
                        }
                    },
                    trailingIcon = {
                        if (query.isNotEmpty()) {
                            IconButton(onClick = { onQueryChange("") }) {
                                Icon(Icons.Filled.Close, contentDescription = "Clear")
                            }
                        }
                    },
                    modifier = Modifier.fillMaxWidth()
                ) {
                    SearchResultsOverlay(
                        searchViewModel = searchViewModel,
                        onDismiss = { onExpandedChange(false) }
                    )
                }
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun SearchResultsOverlay(
    searchViewModel: SearchViewModel,
    onDismiss: () -> Unit
) {
    val context = LocalContext.current
    var selectedTab by remember { mutableIntStateOf(0) }
    val tabs = listOf(
        stringResource(R.string.tab_movies),
        stringResource(R.string.tab_series),
        stringResource(R.string.tab_live_tv)
    )
    
    Column(modifier = Modifier.fillMaxSize()) {
        PrimaryTabRow(selectedTabIndex = selectedTab) {
            tabs.forEachIndexed { index, title ->
                Tab(
                    selected = selectedTab == index,
                    onClick = { selectedTab = index },
                    text = { Text(title) }
                )
            }
        }
        
        if (searchViewModel.isLoading.value) {
            CenteredProgressBar()
        } else {
            when (selectedTab) {
                0 -> {
                    when (val moviesState = searchViewModel.movies.value) {
                        is UiState.Loading -> CenteredProgressBar()
                        is UiState.Success -> {
                            if (moviesState.data.isEmpty()) {
                                Box(
                                    modifier = Modifier.fillMaxSize(),
                                    contentAlignment = Alignment.Center
                                ) {
                                    Text(
                                        text = "No movies found",
                                        style = MaterialTheme.typography.bodyLarge,
                                        color = MaterialTheme.colorScheme.onSurfaceVariant
                                    )
                                }
                            } else {
                                com.hasanege.materialtv.ui.MoviesList(moviesState.data)
                            }
                        }
                        is UiState.Error -> ErrorMessage(moviesState.message)
                    }
                }
                1 -> {
                    when (val seriesState = searchViewModel.series.value) {
                        is UiState.Loading -> CenteredProgressBar()
                        is UiState.Success -> {
                            if (seriesState.data.isEmpty()) {
                                Box(
                                    modifier = Modifier.fillMaxSize(),
                                    contentAlignment = Alignment.Center
                                ) {
                                    Text(
                                        text = "No series found",
                                        style = MaterialTheme.typography.bodyLarge,
                                        color = MaterialTheme.colorScheme.onSurfaceVariant
                                    )
                                }
                            } else {
                                com.hasanege.materialtv.ui.SeriesList(seriesState.data)
                            }
                        }
                        is UiState.Error -> ErrorMessage(seriesState.message)
                    }
                }
                2 -> {
                    when (val liveState = searchViewModel.liveStreams.value) {
                        is UiState.Loading -> CenteredProgressBar()
                        is UiState.Success -> {
                            if (liveState.data.isEmpty()) {
                                Box(
                                    modifier = Modifier.fillMaxSize(),
                                    contentAlignment = Alignment.Center
                                ) {
                                    Text(
                                        text = "No live streams found",
                                        style = MaterialTheme.typography.bodyLarge,
                                        color = MaterialTheme.colorScheme.onSurfaceVariant
                                    )
                                }
                            } else {
                                com.hasanege.materialtv.ui.LiveTVList(liveState.data)
                            }
                        }
                        is UiState.Error -> ErrorMessage(liveState.message)
                    }
                }
            }
        }
    }
}
